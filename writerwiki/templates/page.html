<!doctype html>

<html>

<head>
    <title>WriterWiki</title>
    <link rel="stylesheet" type="text/css" href="/static/bootstrap.css"/>
    <link rel="stylesheet" type="text/css" href="/static/styles.css"/>
    <script type="text/javascript" src="/static/jquery.js"></script>
    
    <script type="text/javascript">

$(document).ready(function(){
    periodicSave()
    workingSetButton()
    pageTags()
    
    $('#snapshot').click(function(){
        var body = $("textarea")[0].value
        var obj = { content : body, commit : true }
        $.post('/page/{{ page.name }}', obj)
    });
    
    $('#insert_template').click(function(){
        var name = $('#template')[0].value
        $.get('/template/' + name + ".txt", function(t){
            $("textarea")[0].value += t
        })
    });
    
    $('#addtowork').click(function() {
        
    });
    
 });
 
 // doesn't work in chrome
 $(window).unload(function(){
    var body = $("textarea")[0].value
    var obj = { content : body, commit : true }
    $.post('/page/{{ page.name }}', obj)
});

function periodicSave()
{
    var body = $("textarea")[0].value
    doSave("{{ page.name }}", body)
    // save every 30 seconds
    var t = setTimeout("periodicSave()", 20000);
}

function doSave(name, body)
{
    var obj = { content : body }
    $.post('/page/' + name, obj)
}

function workingSetButton()
{
    $.get('/api/working', function(t) {
        var page = "{{ page.name }}"
        var j = eval("(" + t + ")")
        var contains = false;
        for (var i = 0; i < j.length; i++)
        {
            if (j[i] === page)
            {
                contains = true;
                break;
            }
        }
        if (contains)
        {
            removeFromWorkingSetButton()
        }
        else
        {
            addToWorkingSetButton()
        }
    });
}

function addToWorkingSetButton()
{
    $('#removefromworkingset').detach()
    $('#toolsform').append('<input id="addtoworkingset" type="button" value="Add to WorkingSet">')
    $("#addtoworkingset").click(function(){
        $.post('/api/working/{{ page.name }}', removeFromWorkingSetButton);
    });
}

function removeFromWorkingSetButton()
{
    $('#addtoworkingset').detach()
    $('#toolsform').append('<input id="removefromworkingset" type="button" value="Remove from WorkingSet">')
    $('#removefromworkingset').click(function() {
        $.ajax('/api/working/{{ page.name }}', {"type" : "DELETE"})
            .success(addToWorkingSetButton);
    });
}

function pageTags()
{
    $.get('/api/tags/{{ page.name }}', function(t) {
        var j = eval("(" + t + ")")
        var tags = ""
        for (var i = 0; i < j.length; i++)
        {
            if (i > 0)
            {
                tags += ", "
            }
            tags += j[i]
        }
        $('#wiki').append('<strong>Tags</strong>&nbsp;<input type="text" id="tags" name="tags" value="' + tags + '">')
        $('#tags').blur(function() {
            var body = $(this)[0].value
            var obj = { tags : body }
            $.post('/api/tags/{{ page.name }}', obj)
        });
    });
}

    </script>
</head>

<body>

{% include 'navigation.html' %}

<section id="main">
<h1>{{ page.name }}</h1>

<form id="wiki">
    <textarea id="textarea" name="content">{{ page.content.read() }}</textarea><br>
</form>
</section>


<nav id="tools">
<form id="toolsform">
<!--
<select id="template" name="template">
    {% for t in templates -%}
        <option value="{{ t }}">{{ t }}</option>
    {%- endfor %}
    </select><br>
    <input id="insert_template" type="button" value="Insert Template"><br>
    -->
    <input id="snapshot" type="button" value="Snapshot">
    <input id="addtowork" type="button" value="Add to Work">
</form>
</nav>

</body>

</html>

